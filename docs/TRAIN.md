# 训练监控指标说明 (Training Metrics Guide)

本文档记录当前强化学习训练脚本 (`train.py`) 中写入 TensorBoard 的三个自定义关键指标，帮助你在手动调参与阶段切换时快速判断训练状态。

## 指标总览

| 指标名       | TensorBoard 路径              | 类型           | 统计周期          | 作用概述                                                                                                                |
| ------------ | ----------------------------- | -------------- | ----------------- | ----------------------------------------------------------------------------------------------------------------------- |
| 好炸弹触发率 | `custom/good_bomb_rate`       | 比例 (0~1)     | 每个 rollout 结束 | 衡量策略在本批采样中放出的炸弹中，有多少步产生了“好炸弹”奖励（即炸弹爆炸十字范围覆盖到至少 1 个可摧毁障碍的放置行为）。 |
| 破障奖励累计 | `custom/destroy_obstacle_sum` | 累计和（浮点） | 每个 rollout 结束 | 本次 rollout 内通过实际炸开障碍获得的总奖励，直接反映“解封进展”。                                                       |
| 眩晕事件率   | `custom/stun_rate`            | 比例 (0~1)     | 每个 rollout 结束 | 表示当前采样中有多少步发生了己方任一角色 GOOD→BAD 的眩晕事件，衡量生存/躲避质量。                                       |

> 说明：一个 _rollout_ 在当前配置下大小约等于 `n_steps`（单环境时），你使用的是 `n_steps=512`，因此这些指标大约每 512 环境步刷新一次。

---

## 1. `custom/good_bomb_rate`

**定义**：在一个 rollout 中，`reward_detail["place_good_bomb_reward"] > 0` 的 step 次数 / rollout 总步数。

**意义**：衡量策略是否在“目标导向”放置炸弹（即放置的炸弹有潜力炸到可破坏障碍）。

**典型趋势解读**：

- 长期接近 0：策略要么不放炸弹，要么乱放但不命中有价值障碍。→ 可提高 `W_PLACE_GOOD_BOMB` 或降低 `|W_STUN|`。
- 适中上升后趋于稳定（例如 0.02 ~ 0.08）：说明开始具备“识别可破坏障碍并尝试”能力。
- 过高（>0.15）且同时 `stun_rate` 偏高：说明可能出现“过度刷好炸弹”而忽视安全。→ 适当降低 `W_PLACE_GOOD_BOMB` 或加入逃生/安全奖励，或提高眩晕惩罚。

**常见误判来源**：如果没有过滤“新炸弹”而重复奖励，会虚高（当前已经避免了）。

---

## 2. `custom/destroy_obstacle_sum`

**定义**：本 rollout 内 `reward_detail["destroy_obstacle_reward"]` 的累加值（等价于炸开的障碍数量 \* 单个障碍奖励）。

**意义**：直接衡量“解封进展速度”。比 `good_bomb_rate` 更靠后（实际成功炸开 vs. 仅具潜力）。

**典型趋势解读**：

- 持续为 0：
  - 可能：地图几乎没有可破坏障碍（确认场景）
  - 或：策略未形成有效放置+逃离 → 需要增加 good bomb 奖励或减少眩晕惩罚。
- 缓慢上升：正常；早期阶段只要证明不是 0 即说明路径被学到。
- 突然下降到 0 且 `good_bomb_rate` 也下降：策略可能学到“放炸弹导致风险 > 收益”并退化。

**判断是否进入下一阶段（加入占领奖励）的辅助信号**：在多个连续 rollout 中 `destroy_obstacle_sum` > 0 且 `stun_rate` 下降，就说明“破障技能基本掌握”。

---

## 3. `custom/stun_rate`

**定义**：rollout 中发生眩晕（己方任一玩家 GOOD→BAD）步数 / 总步数。并非“眩晕事件数”，而是“那些触发事件的时间步”占比。

**意义**：负面安全指标；目标是让它下降。与前两个正向指标一起观察才能避免“只会苟且不放炸弹”。

**典型趋势解读**：

- 早期可能较高：策略尚未学习逃离时机。
- 若与 `good_bomb_rate` 同步上升：策略在积极探索，短期允许。
- 若 `good_bomb_rate` 低而 `stun_rate` 高：糟糕（盲目操作）。调整奖励结构。
- 长期几乎为 0 且 `good_bomb_rate` 也很低：策略可能“学会不动或只走安全路线”→ 需鼓励投放（上调 `W_PLACE_GOOD_BOMB`）。

**与眩晕惩罚的协同**：当 `stun_rate` 不再显著下降而 `destroy_obstacle_sum` 停滞，可轻微增加 `|W_STUN|` 获得进一步压制；但要防止炸弹使用被整体抑制。

---

## 联合使用建议

| 目标               | 关注主指标                             | 辅助判据            | 调参方向                                         |
| ------------------ | -------------------------------------- | ------------------- | ------------------------------------------------ | ------ | --- |
| 放得太少           | good_bomb_rate≈0                       | stun_rate 也低      | ↑ W_PLACE_GOOD_BOMB 或 ↓                         | W_STUN |     |
| 放得太猛且常自爆   | stun_rate 高 & destroy_obstacle_sum 低 | good_bomb_rate 高   | ↓ W_PLACE_GOOD_BOMB 或 ↑                         | W_STUN |     |
| 能放会炸但总自伤   | destroy_obstacle_sum>0 & stun_rate 高  | good_bomb_rate 中高 | 加“逃生成功奖励”或减 stun 惩罚幅度后再分阶段上调 |
| 破障完成准备转占领 | destroy_obstacle_sum 稳定>0            | stun_rate 持续下降  | 加入/提升占领奖励，或切换奖励模式                |

---

## 典型观察窗口

- 使用当前 `n_steps=512`，可以每 10 个 rollout ≈ 5k steps 为一个人工评估窗口。
- 记录三条曲线的 _移动平均_（TensorBoard 里可开 smoothing）来判断趋势，而不是单点波动。

---

## 常见问题排查

| 现象                                            | 可能原因                                                        | 对策                                                                     |
| ----------------------------------------------- | --------------------------------------------------------------- | ------------------------------------------------------------------------ | ------ | ---------------------------------------- |
| 三个指标全部接近 0                              | 奖励未正确写入 / 回调未被注册                                   | 检查 `train.py` 回调列表 & `reward_detail` 字段存在性                    |
| good_bomb_rate>0 但 destroy_obstacle_sum 永远 0 | 炸弹射程不足 / 障碍不在范围 / reward 计算依赖上一帧炸弹列表 bug | 打印回合内炸弹信息，确认 `_compute_destroy_obstacle_reward` 路径是否触发 |
| stun_rate 持续高企                              | 躲避特征不明显 / 惩罚过轻 / 值函数不稳定                        | 提高                                                                     | W_STUN | ，或为危险格添加更显式特征层（紧急掩码） |

---

## 后续扩展（可选）

- 增加 `custom/bomb_action_rate`：无奖励的炸弹尝试也计数 → 分析策略是否在“消极不放”。
- 增加 `custom/destroy_events`：直接记录推算出的破障个数（= destroy_obstacle_sum / W_DESTROY_OBSTACLE）。
- 分离 `self_stun_rate` 与 `enemy_stun_rate` 以便精准调参。

---

## 快速复盘模板

手动调参日志可记录：

```
# Step ~5000
good_bomb_rate=0.01  destroy_obstacle_sum=3  stun_rate=0.22
调整: W_PLACE_GOOD_BOMB 0.8 -> 1.2, 保持 W_STUN -1

# Step ~10000
good_bomb_rate=0.05  destroy_obstacle_sum=9  stun_rate=0.15
计划: 继续观察，暂不切换到占领奖励
```

---

如需我帮你自动化这些统计的滑动窗口/建议切换逻辑，可以再开一个 Issue 或直接提出需求。
