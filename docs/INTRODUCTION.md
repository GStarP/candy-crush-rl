# 编程大赛 4.0《糖豆战阵》技术文档

## 一、游戏介绍

双方控制糖豆人进行 2V2 对战，走过的格子视作自己占领的地盘，在一定时间的对战后，占据格子数量多的队伍获胜。在对战期间，双方可以拾取各类道具提升糖豆人的能力。

- 2V2，游戏中每支队伍各控制 2 个糖豆人，共 4 个糖豆人，队伍外观分为偏蓝色一方和偏红色一方，出生点在地图四角；
- 糖豆人每走过一个格子，视作占领这个格子，并将格子涂为红色或者蓝色进行标识；
- 糖豆人可以放下炸弹，经过一段时间后，炸弹爆炸，炸晕以炸弹为中心的一个“十”字范围内的其他糖豆人，抢夺一部分占领的格子并使其丢失所有道具，爆炸会被障碍物阻挡；
- 可破坏的障碍物被破坏后，可能在原地掉落不同的道具，糖豆人可以拾取道具，提升自身的能力，在对抗中取得优势；
- 比赛中存在一些特殊的地形，比如减速点会减缓糖豆人的移动速度，可以多多加以利用；
- 比赛总共进行三分钟，比赛结束后，占据格子数量多的队伍取得胜利；

## 二、游戏机制介绍

### 2.1 糖豆人机制

1. 出生点：地图四角，随机刷新；
2. 速度：2 格/秒，可以通过拾取特定的道具提升速度；
3. 移动：受玩家控制，可以进行上下左右移动，无法穿过障碍物，无法穿过其他糖豆人已经放置的炸弹，可以穿过其他糖豆人；
4. 放置炸弹：受玩家控制，玩家可以在每次移动后决定糖豆人是否同时放下一个炸弹。糖豆人只能一次放置一个炸弹，上一个炸弹未爆炸时，不可以再次放置炸弹，可以通过拾取特定道具提升可同时放置的炸弹数量；
5. 炸晕：被炸弹爆炸伤害时，糖豆人被炸晕，原地不动，丢失所有已获取的道具（但不会低于初始值）并损失三分之一的占领格（向下取整），如果糖豆人是被敌方炸晕，敌方糖豆人将会获取这部分损失的占领格；
6. 苏醒：糖豆人被炸晕后 3 秒后，将在原地苏醒，苏醒后的 3 秒内，将处于无敌状态并获得穿越炸弹的能力；
7. 占领：糖豆人移动到任意一个已被敌方占领或未被占领的格子时，将视作占领这个格子，更多详细说明详见占领机制；

### 2.2 炸弹机制

1. 炸弹放置：炸弹将被放置到中心点距离糖豆人最近的格子上；
2. 爆炸时间：炸弹会在放置后经过 2 秒自动引爆；
3. 爆炸范围：炸弹爆炸时，默认覆盖以炸弹为中心一个“十字”范围，各边的波及范围为 1 格，总爆炸范围为 5 格，如下图所示，可以通过拾取特定的道具增加波及范围；
4. 级联引爆：爆炸范围内如果存在其他没有爆炸的炸弹，将同时引爆；
5. 队友伤害：糖豆人放置的炸弹会伤害自己和队友；
6. 减速效果：踩在敌方队伍放置的炸弹上速度减半；

### 2.3 地图机制

地图展示所有糖豆人，道具等位置，地图的格子本身具备以下属性

- 糖豆人出生点：出生点和出生点附近固定为平地，位于地图四角
- 平地：可被占领，糖豆人在平地上正常行走
- 减速点：可被占领，糖豆人在减速点上移动速度更慢
- 加速点：可被占领，糖豆人在加速点上移动速度更快
- 不可破坏障碍物：通过炸弹无法破坏的障碍物
- 可破坏障碍物：可以破坏的障碍物，破坏后，该格子转变为平地，并可能掉落道具

> 实际比赛过程中，每次加载地图都会在若干地图中随机选择一个，不同地图的尺寸固定，但样式和结构不同，地图中必然存在糖豆人出生点、不可破坏障碍物、可破坏障碍物和平地，可能存在减速点和加速点。

### 2.4 道具机制

每次通过炸弹破坏可破坏障碍物时，有一定概率会出现道具，包含以下三种

1. 炸弹背包：获取后，糖豆人可以同时放置的炸弹+1，初始数量为 1（可同时放置 1 个炸弹），上限为 5（可同时放置 5 个炸弹）；
2. 强化药水：获取后，糖豆人释放的炸弹爆炸时的波及范围+1，初始数量为 1（炸弹波及范围为 1 格），上限为 5（炸弹波及范围为 5 格）；
3. 灵巧飞靴：获取后，糖豆人移动速度增加 0.4 格/秒，初始数量为 0（初始速度为 2 格/秒），上限为 3（上限速度为 3.2 格/秒）；

### 2.5 占领机制

1. 初始时所有格子视作未占领；
2. 糖豆人在移动过程中，会不断占领格子；
3. 多个糖豆人同时移动到同一个格子时，将按照如下规则进行判定
4. 如果两个糖豆人同时占领一个格子，且糖豆人所属队伍相同时，糖豆人编号（游戏开始时随机生成）较小的占领格子；
5. 如果两个糖豆人同时占领一个格子，且糖豆人归属队伍不同时，假设两队人编号分别为”红 1，红 2，蓝 1，蓝 2“，则按照红 1>蓝 1>红 2>蓝 2>红 1 的逻辑判断占领，即每队必然有一个糖豆人优先级高于敌方队伍的一个糖豆人并低于敌方队伍的一个糖豆人，相关的优先级顺序会每隔一段时间发生变化；
6. 如果三个糖豆人同时占领一个格子，则糖豆人较多的队伍占领该格，并且由糖豆人编号（游戏开始时随机生成）较小的糖豆人占领格子；
7. 如果四个糖豆人同时移动到同一个格子，那么格子将判定为不被占领；
8. 队友已经占领的格子，糖豆人不会重复占领；
9. 判定体积：糖豆人所在的 50\*50 的横截面，至少需要与地图格子存在面积不为 0 的重合部分，才判定糖豆人接触到了这个格子，类似的判定机制将在游戏中所有碰撞判定的逻辑中生效，包括但不限于”炸弹爆炸是否炸晕糖豆人“，”获取道具“等；

### 2.6 获胜机制

1. 比赛时长固定为 3 分钟；
2. 比赛结束时按顺序基于以下规则判断胜者；
3. 判断两队占领格子的数量，占领格子数量多的队伍获胜；
4. 如果最终两队占领格子的数量相同，则击杀次数更多的队伍获胜；
5. 如果最终两队的击杀次数相同，则最终拥有道具数量多的队伍获胜；

## 三、接入指南

### 3.3 游戏请求玩家操作命令接口

- 请求方式：POST
- 请求路径：/api/v1/command
- 请求和响应的数据类型要求如下
  - Content-Type: application/json; charset=utf-8
  - Accept: application/json; charset=utf-8
- 要求在 90 毫秒内返回，超过 90 毫秒视作当前 tick 不进行任何操作

### 3.5 每一帧推送游戏状态

#### 3.5.1 总体参数说明

| 参数名           | 类型            | 解释                                                                    |
| ---------------- | --------------- | ----------------------------------------------------------------------- |
| current_match_id | string          | 本局比赛的 ID，可用于辅助处理一个机器人端点同时被多个后端服务调用的情况 |
| current_tick     | int             | 当前帧，从 1 开始                                                       |
| map              | [][]Cell        | 地图数组，每个格子的状态用结构体 cell 表示                              |
| my_player        | PlayerStateVo   | 糖豆人状态结构体，代表当前糖豆人                                        |
| other_players    | []PlayerStateVo | 其他糖豆人状态结构体数组，包含除了当前糖豆人外的剩下 3 个糖豆人         |
| bombs            | []Bomb          | 炸弹结构体数组，记录当前地图上存在还没爆炸的所有炸弹                    |
| map_items        | []MapItem       | 道具结构体数组，记录当前地图上所有掉落的道具                            |

#### 3.5.2 所有常数枚举说明

| 枚举类型  | 解释         | 各个枚举含义                                                      |
| --------- | ------------ | ----------------------------------------------------------------- |
| team      | 队伍颜色     | R：红队，B：蓝队                                                  |
| status    | 常规状态类型 | A：正常状态，D：炸晕状态                                          |
| direction | 方向类型     | N：无方向/静止，U：上，D：下，L：左，R：右                        |
| terrain   | 地形类型     | P：平地，B：加速点，M：减速点，I：不可破坏障碍物，D：可破坏障碍物 |
| ownership | 占领状态     | N：未被占领，R：红队占领，B：蓝队占领                             |
| item_type | 道具类型     | BP：炸弹背包，SP：强化药水，AB：灵巧飞靴                          |

#### 3.5.3 Cell 结构体说明

| 参数名    | 类型   | 解释                                      |
| --------- | ------ | ----------------------------------------- |
| terrain   | string | 地形，枚举值详见 3.5.2 地形类型           |
| ownership | string | 占领状态(队伍)，枚举值详见 3.5.2 占领状态 |
| owner_id  | int    | 被哪个角色占领                            |

#### 3.5.4 PlayerStateVo 结构体说明

| 参数名              | 类型          | 解释                                      |
| ------------------- | ------------- | ----------------------------------------- |
| id                  | int           | 糖豆人编号，每局游戏独立生成              |
| team                | string        | 队伍颜色，枚举值详见 3.5.2 队伍颜色       |
| status              | string        | 常规状态，枚举值详见 3.5.2 常规状态类型   |
| position            | PixelPosition | 糖豆人位置，中心点像素坐标                |
| direction           | string        | 糖豆人当前朝向，枚举值详见 3.5.2 方向类型 |
| bomb_pack_count     | int           | 糖豆人拥有的炸弹背包数量                  |
| sweet_potion_count  | int           | 糖豆人拥有的强化药水数量                  |
| agility_boots_count | int           | 糖豆人拥有的灵巧飞靴数量                  |

##### 3.5.4.2 PixelPosition 结构体说明

| 参数名 | 类型 | 解释     |
| ------ | ---- | -------- |
| x      | int  | 像素坐标 |
| y      | int  | 像素坐标 |

#### 3.5.5 Bomb 结构体说明

| 参数名     | 类型     | 解释                                            |
| ---------- | -------- | ----------------------------------------------- |
| position   | Position | 炸弹位置，格子坐标                              |
| owner_id   | int      | 放置炸弹的糖豆人                                |
| team       | string   | 放置炸弹的糖豆人所属的队伍，详见 3.5.2 队伍颜色 |
| range      | int      | 爆炸的波及范围，单位为格子数                    |
| explode_at | int      | 炸弹爆炸的游戏刻（Tick）                        |

##### 3.5.6.1 Position 结构体说明

| 参数名 | 类型 | 解释     |
| ------ | ---- | -------- |
| x      | int  | 格子坐标 |
| y      | int  | 格子坐标 |

#### 3.5.6 MapItem 结构体说明

| 参数名   | 类型     | 解释                                 |
| -------- | -------- | ------------------------------------ |
| type     | string   | 道具种类，枚举值详见 3.5.2，道具类型 |
| position | Position | 格子坐标                             |

### 3.6 玩家每一帧返回的命令

返回命令要求包含以下字段

| 参数名        | 类型   | 解释               | 注意事项                                                                                                                                                                                                                         |
| ------------- | ------ | ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| direction     | string | 移动方向           | 枚举值详见 3.5.2 方向类型                                                                                                                                                                                                        |
| is_place_bomb | bool   | 当前帧是否放置炸弹 |
| stride        | int    | 移动步长           | 游戏允许玩家精细控制单次移动的步长，比如糖豆人最终速度为 15 像素/Tick 时，糖豆人当前 Tick 将默认移动 15 个像素，不输入此参数或输入 0，则糖豆人将按照默认值移动 15 个像素，同时也可以通过输入具体的步长，控制糖豆人移动[1,14]像素 |

## 四、机器人玩家开发注意事项

### 4.1 坐标映射关系

上文提到两个概念 PixelPosition（像素坐标）和 Position（格子坐标），地图固定由 28\*16=448 个格子组成，原点位于地图左下角。

1. 格子坐标为(0, 0)的格子，其中心点像素坐标为（25，25），在地图中获取格子信息的方式为 map[0][0]；
2. 格子坐标为（27,15）的格子，其中心点像素坐标为（50*27+25,50*15+25），在地图中获取格子信息的方式为 map[15][27]；

### 4.2 FAQ

1. 如果炸弹爆炸时，糖豆人刚好脱离爆炸范围，会如何判定？
   a. 判定为没有被炸到，先判定糖豆人的移动，再判定炸弹爆炸，同理，糖豆人刚好走入炸弹范围也会判定被炸到；
2. 同时接触加速点和减速点的情况下，糖豆人会加速还是减速？
   a. 实际地图中不会出现这种情况；
3. 如果炸弹爆炸时，糖豆人处于爆炸范围内且刚好放置炸弹，会如何判定？
   a. 判定为同时引爆了刚刚放置的炸弹；
4. 糖豆人刚好处于两个格子交界处时，放置炸弹将如何判定？
   a. 随机在其中的一个格子放置炸弹；
5. 两个炸弹人同时在一个格子放置炸弹/同时移动到有格子的道具时如何判断优先级？
   a. 与占领格子的判断类似，采用相对固定但会随时间变化的相对优先级顺序，且优先级顺序必然与占领格子相反，即优先占格子的糖豆人必然相对不优先放置炸弹；
